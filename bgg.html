<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>六十四卦定位练习</title>
    <style>
        body {
            font-family: "SimSun", "宋体", serif;
            margin: 10px;
            text-align: center;
        }
        .flashcard {
            margin: 10px auto;
            padding: 15px;
            border: 2px solid #333;
            border-radius: 8px;
            max-width: 100%;
            background-color: #f9f9f9;
        }
        .symbol {
            font-size: 36px;
            line-height: 1.2;
            margin-bottom: 8px;
        }
        .name {
            font-size: 18px;
            margin-bottom: 15px;
        }
        button {
            padding: 8px 16px;
            font-size: 14px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 8px;
        }
        button:hover {
            background-color: #45a049;
        }
        #toggle-btn {
            background-color: #2196F3;
        }
        #toggle-btn:hover {
            background-color: #0b7dda;
        }
        .hint-text {
            text-align: left;
            font-size: 12px;
            color: #666;
            margin-top: 10px;
            line-height: 1.4;
        }
        table {
            border-collapse: collapse;
            width: 100%;
            margin-top: 20px;
            font-size: 14px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 4px;
            text-align: center;
        }
        th {
            background-color: #f2f2f2;
            font-weight: bold;
            padding: 6px;
        }
        .table-symbol {
            font-size: 18px;
            line-height: 1.2;
        }
        .hidden {
            display: none;
        }
        .highlight {
            background-color: #ffeb3b;
        }
        .pure-gua {
            background-color: #e6f7ff;
        }

        /* 响应式设计 */
        @media (max-width: 600px) {
            .symbol {
                font-size: 28px;
            }
            .name {
                font-size: 16px;
            }
            .hint-text {
                font-size: 11px;
            }
            table {
                font-size: 12px;
            }
            th, td {
                padding: 2px;
            }
            .table-symbol {
                font-size: 16px;
            }
        }
    </style>
</head>
<body>
    <h3>六十四卦定位练习</h3>
    
    <div class="flashcard" id="flashcard">
        <div class="symbol" id="symbol"></div>
        <div class="name" id="name"></div>
        <p>这个卦应该在哪一个宫位？</p>
        <button id="next-btn">下一个</button>
        <button id="toggle-btn">显示所有卦</button>
        <div class="hint-text">
            世应诀：天同二世天变五，地同四世地变初，本宫六世三世异，人同游魂人变归。<br>
            寻宫诀：一二三六外卦宫，四五游魂内变更，归魂内卦是本宫。
        </div>
    </div>

    <div id="bagua-table"></div>

    <script>
        // 数据定义
        const lssg = ["䷀", "䷁", "䷂", "䷃", "䷄", "䷅", "䷆", "䷇", "䷈", "䷉", "䷊", "䷋", "䷌", "䷍", "䷎", "䷏", "䷐", "䷑", "䷒", "䷓", "䷔", "䷕", "䷖", "䷗", "䷘", "䷙", "䷚", "䷛", "䷜", "䷝", "䷞", "䷟", "䷠", "䷡", "䷢", "䷣", "䷤", "䷥", "䷦", "䷧", "䷨", "䷩", "䷪", "䷫", "䷬", "䷭", "䷮", "䷯", "䷰", "䷱", "䷲", "䷳", "䷴", "䷵", "䷶", "䷷", "䷸", "䷹", "䷺", "䷻", "䷼", "䷽", "䷾", "䷿"];
        const lssgm = ["乾為天", "坤為地", "水雷屯", "山水蒙", "水天需", "天水訟", "地水師", "水地比", "風天小畜", "天澤履", "地天泰", "天地否", "天火同人", "火天大有", "地山謙", "雷地豫", "澤雷隨", "山風蠱", "地澤臨", "風地觀", "火雷噬嗑", "山火賁", "山地剝", "地雷復", "天雷无妄", "山天大畜", "山雷頤", "澤風大過", "坎為水", "離為火", "澤山咸", "雷風恆", "天山遯", "雷天大壯", "火地晉", "地火明夷", "風火家人", "火澤睽", "水山蹇", "雷水解", "山澤損", "風雷益", "澤天夬", "天風姤", "澤地萃", "地風升", "澤水困", "水風井", "澤火革", "火風鼎", "震為雷", "艮為山", "風山漸", "雷澤歸妹", "雷火豐", "火山旅", "巽為風", "兌為澤", "風水渙", "水澤節", "風澤中孚", "雷山小過", "水火既濟", "火水未濟"];
        
        const bagong = [
            [1, 44, 33, 12, 20, 23, 35, 14],    // 乾宫
            [2, 24, 19, 11, 34, 43, 5, 8],      // 坤宫
            [52, 22, 26, 41, 38, 10, 61, 53],   // 艮宫
            [58, 47, 45, 31, 39, 15, 62, 54],   // 兑宫
            [30, 56, 50, 64, 4, 59, 6, 13],     // 离宫
            [29, 60, 3, 63, 49, 55, 36, 7],     // 坎宫
            [51, 16, 40, 32, 46, 48, 28, 17],   // 震宫
            [57, 9, 37, 42, 25, 21, 27, 18]     // 巽宫
        ];
        
        // 表头
        const headers = ['纯卦','一世','二世','三世','四世','五世','游魂','归魂'];
        
        // 创建表格
        function createBaguaTable() {
            const table = document.createElement('table');
            
            // 创建表头
            const thead = document.createElement('thead');
            const headerRow = document.createElement('tr');
            
            // 添加表头
            headers.forEach(header => {
                const th = document.createElement('th');
                th.textContent = header;
                headerRow.appendChild(th);
            });
            
            thead.appendChild(headerRow);
            table.appendChild(thead);
            
            // 创建表格内容
            const tbody = document.createElement('tbody');
            
            // 遍历八宫
            for (let i = 0; i < bagong.length; i++) {
                const row = document.createElement('tr');
                
                // 添加每宫的八卦
                for (let j = 0; j < bagong[i].length; j++) {
                    const index = bagong[i][j] - 1; // 转换为0-based索引
                    const cell = document.createElement('td');
                    cell.dataset.guaIndex = index;
                    
                    // 创建内容
                    const symbolDiv = document.createElement('div');
                    symbolDiv.className = 'table-symbol';
                    symbolDiv.textContent = lssg[index];
                    
                    const nameDiv = document.createElement('div');
                    nameDiv.textContent = lssgm[index];
                    
                    // 如果是纯卦列(j=0)，始终显示
                    if (j === 0) {
                        cell.classList.add('pure-gua');
                    } else {
                        symbolDiv.classList.add('hidden');
                        nameDiv.classList.add('hidden');
                    }
                    
                    cell.appendChild(symbolDiv);
                    cell.appendChild(nameDiv);
                    row.appendChild(cell);
                }
                
                tbody.appendChild(row);
            }
            
            table.appendChild(tbody);
            return table;
        }
        
        // 渲染表格
        document.getElementById('bagua-table').appendChild(createBaguaTable());

        // 闪卡功能
        const symbolElement = document.getElementById('symbol');
        const nameElement = document.getElementById('name');
        const nextBtn = document.getElementById('next-btn');
        const toggleBtn = document.getElementById('toggle-btn');
        const tableCells = document.querySelectorAll('td');
        
        // 记录已提问的卦索引
        let askedIndices = [];
        let currentIndex = -1;
        let isShowingAll = false;
        
        // 获取安全的随机数
        function getRandomIndex() {
            const array = new Uint32Array(1);
            window.crypto.getRandomValues(array);
            return array[0] % lssg.length;
        }
        
        // 获取新的随机卦，确保10次内不重复
        function getRandomGua() {
            if (askedIndices.length >= 10) {
                askedIndices = [];
            }
            
            let index;
            do {
                index = getRandomIndex();
            } while (askedIndices.includes(index) || isPureGua(index));
            
            askedIndices.push(index);
            return index;
        }
        
        // 检查是否为纯卦
        function isPureGua(index) {
            for (let i = 0; i < bagong.length; i++) {
                if (bagong[i][0] - 1 === index) {
                    return true;
                }
            }
            return false;
        }
        
        // 显示随机卦
        function showRandomGua() {
            currentIndex = getRandomGua();
            symbolElement.textContent = lssg[currentIndex];
            nameElement.textContent = lssgm[currentIndex];
            
            // 重置表格状态
            tableCells.forEach(cell => {
                const guaIndex = parseInt(cell.dataset.guaIndex);
                const symbolDiv = cell.querySelector('.table-symbol');
                const nameDiv = cell.querySelector('div:not(.table-symbol)');
                
                cell.classList.remove('highlight');
                cell.style.backgroundColor = '';
                
                // 如果不是纯卦列且不是显示所有状态，隐藏内容
                if (!cell.classList.contains('pure-gua') && !isShowingAll) {
                    symbolDiv.classList.add('hidden');
                    nameDiv.classList.add('hidden');
                }
            });
        }
        
        // 切换显示/隐藏所有卦
        function toggleAllGua() {
            isShowingAll = !isShowingAll;
            toggleBtn.textContent = isShowingAll ? '隐藏其他卦' : '显示所有卦';
            
            tableCells.forEach(cell => {
                if (!cell.classList.contains('pure-gua')) {
                    const symbolDiv = cell.querySelector('.table-symbol');
                    const nameDiv = cell.querySelector('div:not(.table-symbol)');
                    
                    if (isShowingAll) {
                        symbolDiv.classList.remove('hidden');
                        nameDiv.classList.remove('hidden');
                    } else {
                        symbolDiv.classList.add('hidden');
                        nameDiv.classList.add('hidden');
                    }
                }
            });
        }
        
        // 处理单元格点击
        function handleCellClick(event) {
            if (currentIndex === -1) return;
            
            const cell = event.currentTarget;
            const guaIndex = parseInt(cell.dataset.guaIndex);
            
            // 如果是纯卦列，不处理点击
            if (cell.classList.contains('pure-gua')) {
                return;
            }
            
            // 显示该单元格的内容
            const symbolDiv = cell.querySelector('.table-symbol');
            const nameDiv = cell.querySelector('div:not(.table-symbol)');
            symbolDiv.classList.remove('hidden');
            nameDiv.classList.remove('hidden');
            
            // 检查是否正确
            if (guaIndex === currentIndex) {
                cell.classList.add('highlight');
                setTimeout(() => {
                    showRandomGua();
                }, 1000);
            } else {
                cell.style.backgroundColor = '#ffcdd2';
            }
        }
        
        // 初始化
        showRandomGua();
        
        // 事件监听
        nextBtn.addEventListener('click', showRandomGua);
        toggleBtn.addEventListener('click', toggleAllGua);
        tableCells.forEach(cell => {
            cell.addEventListener('click', handleCellClick);
        });
    </script>
</body>
</html>
